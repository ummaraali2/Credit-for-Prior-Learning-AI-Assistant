// Global variables
let uploadedFiles = [];
let waInstance = null;
const BACKEND_URL = 'http://localhost:3000';

// Initialize Watson Assistant
window.watsonAssistantChatOptions = {
    integrationID: "2d6e2e03-4cef-4e0f-b131-f989bc4776d2",
    region: "au-syd",
    serviceInstanceID: "fb664aa6-6a7e-4626-b086-668dc8b1fa15",
    
    onLoad: async (instance) => {
        waInstance = instance;
        
        instance.on({
            type: 'view:change',
            handler: (event) => {
                console.log('üìÑ View changed');
                setTimeout(() => addUploadButtons(instance), 300);
            }
        });
        
        // ATTACH FILES when user clicks send
        instance.on({
            type: 'pre:send',
            handler: (event) => {
                console.log('üîç PRE-SEND triggered');
                console.log('üì¶ Files in array:', uploadedFiles.length);
                
                if (uploadedFiles.length > 0) {
                    console.log('üì§ Attaching', uploadedFiles.length, 'file(s)');
                    
                    // Initialize context for ACTIONS
                    event.data.context = event.data.context || {};
                    event.data.context.skills = event.data.context.skills || {};
                    event.data.context.skills['actions skill'] = event.data.context.skills['actions skill'] || {};
                    event.data.context.skills['actions skill'].skill_variables = event.data.context.skills['actions skill'].skill_variables || {};
                    
                    // Attach files
                    event.data.context.skills['actions skill'].skill_variables.uploaded_files = uploadedFiles.map(f => ({
                        id: f.id.toString(),
                        name: f.name,
                        size: f.size,
                        type: f.type,
                        cosUrl: f.cosUrl || '',
                        cosKey: f.cosKey || '',
                        analysisResult: f.analysisResult || ''
                    }));
                    
                    console.log('‚úÖ Files attached to Actions skill');
                    
                    // If no text, add default message
                    if (!event.data.input.text || event.data.input.text.trim() === '') {
                        event.data.input.text = `üìé Uploaded ${uploadedFiles.length} document(s)`;
                        console.log('üìù Added auto-message');
                    }
                }
            }
        });
        
        // Clear files after send
        instance.on({
            type: 'send',
            handler: () => {
                if (uploadedFiles.length > 0) {
                    console.log('üì® Sent files, clearing');
                    showToast(`Sent ${uploadedFiles.length} file(s)`, 'success');
                    uploadedFiles = [];
                    renderFiles();
                    toggleSendButton();
                }
            }
        });
        
        // Listen for Watson upload requests
        instance.on({
            type: 'customResponse',
            handler: (event) => {
                if (event.data.message.user_defined?.user_defined_type === 'user-file-upload') {
                    console.log('üîî Watson requested upload');
                    document.getElementById('file-upload-input').click();
                }
            }
        });
        
        await instance.render();
        
        setTimeout(() => {
            addUploadButtons(instance);
            enableSendWithFiles(instance);
        }, 500);
        
        console.log('‚úÖ Watson Assistant loaded');
    }
};

// Load Watson Assistant
setTimeout(function() {
    const t = document.createElement('script');
    t.src = "https://web-chat.global.assistant.watson.appdomain.cloud/versions/" + 
            (window.watsonAssistantChatOptions.clientVersion || 'latest') + 
            "/WatsonAssistantChatEntry.js";
    document.head.appendChild(t);
});

// Enable send button with files
function enableSendWithFiles(instance) {
    const checkInterval = setInterval(() => {
        const inputElement = document.querySelector('textarea[placeholder*="Type" i]');
        const sendButton = document.querySelector('button[title*="Send" i], button[aria-label*="Send" i]');
        
        if (inputElement && sendButton) {
            console.log('‚úÖ Found input and send button');
            
            inputElement.addEventListener('input', toggleSendButton);
            toggleSendButton();
            
            clearInterval(checkInterval);
        }
    }, 500);
    
    setTimeout(() => clearInterval(checkInterval), 10000);
}

// Toggle send button
function toggleSendButton() {
    const sendButton = document.querySelector('button[title*="Send" i], button[aria-label*="Send" i]');
    const inputElement = document.querySelector('textarea[placeholder*="Type" i]');
    
    if (!sendButton) return;
    
    const hasText = inputElement && inputElement.value.trim().length > 0;
    const hasFiles = uploadedFiles.filter(f => f.status === 'ready').length > 0;
    
    if (hasText || hasFiles) {
        sendButton.disabled = false;
        sendButton.style.opacity = '1';
        sendButton.style.cursor = 'pointer';
        console.log('‚úÖ Send enabled (text:', hasText, ', files:', hasFiles, ')');
    } else {
        sendButton.disabled = true;
        sendButton.style.opacity = '0.5';
        sendButton.style.cursor = 'not-allowed';
    }
}

// Add upload buttons
function addUploadButtons(instance) {
    if (!instance.writeableElements) {
        setTimeout(() => addUploadButtons(instance), 500);
        return;
    }
    
    addHomePageButton(instance);
    addConversationPageButton(instance);
    setupFileInput();
}

function addHomePageButton(instance) {
    try {
        const homeElement = instance.writeableElements.homeScreenAfterStartersElement;
        if (!homeElement || document.getElementById('cpl-home-upload-btn')) return;
        
        const container = document.createElement('div');
        container.style.cssText = 'display: flex; justify-content: center; padding: 16px;';
        
        const btn = document.createElement('button');
        btn.id = 'cpl-home-upload-btn';
        btn.title = 'Upload Document';
        btn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20">
                <path fill="#999" d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
            </svg>
            <span style="margin-left: 6px; font-size: 13px; color: #999;">Upload Document</span>
        `;
        btn.style.cssText = 'background: transparent; border: none; cursor: pointer; padding: 8px 16px; display: inline-flex; align-items: center; opacity: 0.7; transition: opacity 0.2s; font-family: Lato, sans-serif;';
        btn.onmouseover = () => btn.style.opacity = '1';
        btn.onmouseout = () => btn.style.opacity = '0.7';
        btn.onclick = () => document.getElementById('file-upload-input').click();
        
        container.appendChild(btn);
        homeElement.innerHTML = '';
        homeElement.appendChild(container);
        
        console.log('‚úÖ Home button added');
    } catch (error) {
        console.error('‚ùå Error adding home button:', error);
    }
}

function addConversationPageButton(instance) {
    try {
        const beforeInput = instance.writeableElements.beforeInputElement;
        if (!beforeInput || document.getElementById('cpl-conv-upload-btn')) return;
        
        const container = document.createElement('div');
        container.id = 'cpl-conv-container';
        container.style.cssText = 'display: flex; flex-direction: column; width: 100%;';
        
        const preview = document.createElement('div');
        preview.id = 'cpl-file-preview';
        preview.style.cssText = 'padding: 0 12px 8px 12px; font-family: Lato, sans-serif;';
        
        const bottomRow = document.createElement('div');
        bottomRow.style.cssText = 'display: flex; align-items: center; padding: 8px 12px;';
        
        const btn = document.createElement('button');
        btn.id = 'cpl-conv-upload-btn';
        btn.title = 'Upload Document';
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path fill="#666" d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>';
        btn.style.cssText = 'background: transparent; border: none; cursor: pointer; padding: 6px; display: inline-flex; opacity: 0.7; transition: opacity 0.2s;';
        btn.onmouseover = () => btn.style.opacity = '1';
        btn.onmouseout = () => btn.style.opacity = '0.7';
        btn.onclick = () => document.getElementById('file-upload-input').click();
        
        bottomRow.appendChild(btn);
        container.appendChild(preview);
        container.appendChild(bottomRow);
        
        beforeInput.innerHTML = '';
        beforeInput.appendChild(container);
        
        renderFiles();
        console.log('‚úÖ Conversation button added');
    } catch (error) {
        console.error('‚ùå Error:', error);
    }
}

function setupFileInput() {
    const input = document.getElementById('file-upload-input');
    if (input && !input.dataset.listener) {
        input.addEventListener('change', handleFileSelect);
        input.dataset.listener = 'true';
    }
}

function handleFileSelect(event) {
    const files = event.target.files;
    if (!files.length) return;
    
    Array.from(files).forEach(file => {
        if (!validateFile(file)) return;
        
        uploadedFiles.push({
            id: Date.now() + Math.random(),
            file,
            name: file.name,
            size: file.size,
            type: file.type,
            status: 'pending'
        });
    });
    
    renderFiles();
    toggleSendButton();
    
    uploadedFiles.forEach(f => {
        if (f.status === 'pending') uploadFileToBackend(f);
    });
    
    event.target.value = '';
}

function validateFile(file) {
    const MAX_SIZE = 10 * 1024 * 1024;
    const ALLOWED = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain', 'image/jpeg', 'image/png', 'image/jpg'];
    
    if (file.size > MAX_SIZE) {
        showToast('File too large (max 10MB)', 'error');
        return false;
    }
    
    if (!ALLOWED.includes(file.type)) {
        showToast('Invalid file type', 'error');
        return false;
    }
    
    return true;
}

async function uploadFileToBackend(fileObj) {
    const formData = new FormData();
    formData.append('file', fileObj.file);
    formData.append('fileId', fileObj.id);
    
    fileObj.status = 'uploading';
    renderFiles();
    showToast(`Uploading ${fileObj.name}...`, 'info');
    
    try {
        const response = await fetch(`${BACKEND_URL}/api/upload`, {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) throw new Error('Upload failed');
        
        const result = await response.json();
        fileObj.status = 'ready';
        fileObj.cosUrl = result.cosUrl;
        fileObj.cosKey = result.fileName;
        fileObj.analysisResult = result.analysisResult;
        
        showToast(`‚úì ${fileObj.name} ready`, 'success');
        renderFiles();
        toggleSendButton();
        
    } catch (error) {
        console.error('Upload error:', error);
        fileObj.status = 'error';
        showToast(`Failed: ${fileObj.name}`, 'error');
        renderFiles();
    }
}

function renderFiles() {
    const preview = document.getElementById('cpl-file-preview');
    if (!preview) return;
    
    if (uploadedFiles.length === 0) {
        preview.innerHTML = '';
        preview.style.display = 'none';
        return;
    }
    
    preview.style.display = 'block';
    
    preview.innerHTML = uploadedFiles.map(f => {
        const icon = getIcon(f.type);
        const statusIcon = getStatusIcon(f.status);
        const statusColor = getStatusColor(f.status);
        const displayName = f.name.length > 30 ? f.name.substring(0, 30) + '...' : f.name;
        
        return `
            <div style="display: flex; align-items: center; background: ${statusColor}; padding: 8px 10px; border-radius: 8px; margin-bottom: 6px; border: 1px solid rgba(0,0,0,0.1);">
                <span style="font-size: 20px; margin-right: 8px;">${icon}</span>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 13px; font-weight: 600; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${displayName}</div>
                    <div style="font-size: 11px; color: #666; margin-top: 2px;">${formatSize(f.size)} ‚Ä¢ ${statusIcon} ${f.status}</div>
                </div>
                <button onclick="removeFile('${f.id}')" style="background: #da1e28; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center; margin-left: 8px;" title="Remove">√ó</button>
            </div>
        `;
    }).join('');
}

function removeFile(fileId) {
    uploadedFiles = uploadedFiles.filter(f => f.id != fileId);
    renderFiles();
    toggleSendButton();
    showToast('File removed', 'success');
}

window.removeFile = removeFile;

function enableSendWithFiles(instance) {
    const checkInterval = setInterval(() => {
        const input = document.querySelector('textarea[placeholder*="Type" i]');
        const send = document.querySelector('button[title*="Send" i], button[aria-label*="Send" i]');
        
        if (input && send) {
            console.log('‚úÖ Found input and send button');
            input.addEventListener('input', toggleSendButton);
            toggleSendButton();
            clearInterval(checkInterval);
        }
    }, 500);
    
    setTimeout(() => clearInterval(checkInterval), 10000);
}

function toggleSendButton() {
    const send = document.querySelector('button[title*="Send" i], button[aria-label*="Send" i]');
    const input = document.querySelector('textarea[placeholder*="Type" i]');
    
    if (!send) return;
    
    const hasText = input && input.value.trim().length > 0;
    const hasFiles = uploadedFiles.filter(f => f.status === 'ready').length > 0;
    
    if (hasText || hasFiles) {
        send.disabled = false;
        send.style.opacity = '1';
        send.style.cursor = 'pointer';
    } else {
        send.disabled = true;
        send.style.opacity = '0.5';
        send.style.cursor = 'not-allowed';
    }
}

function getIcon(type) {
    if (type.includes('pdf')) return 'üìÑ';
    if (type.includes('word') || type.includes('document')) return 'üìù';
    if (type.includes('image')) return 'üñºÔ∏è';
    if (type.includes('text')) return 'üìÉ';
    return 'üìé';
}

function getStatusIcon(status) {
    if (status === 'pending') return '‚è≥';
    if (status === 'uploading') return 'üì§';
    if (status === 'ready') return '‚úÖ';
    if (status === 'error') return '‚ùå';
    return 'üìé';
}

function getStatusColor(status) {
    if (status === 'pending') return 'rgba(255, 193, 7, 0.1)';
    if (status === 'uploading') return 'rgba(15, 98, 254, 0.1)';
    if (status === 'ready') return 'rgba(36, 161, 72, 0.1)';
    if (status === 'error') return 'rgba(218, 30, 40, 0.1)';
    return 'rgba(0, 0, 0, 0.05)';
}

function formatSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024, sizes = ['B', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return (bytes / Math.pow(k, i)).toFixed(1) + ' ' + sizes[i];
}

function showToast(message, type = 'info') {
    document.querySelectorAll('.cpl-toast').forEach(el => el.remove());
    
    const toast = document.createElement('div');
    toast.className = 'cpl-toast';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; padding: 12px 20px;
        border-radius: 6px; font-size: 14px; z-index: 999999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-family: Lato, sans-serif;
        ${type === 'success' ? 'background: #24a148; color: white;' : ''}
        ${type === 'error' ? 'background: #da1e28; color: white;' : ''}
        ${type === 'info' ? 'background: #0f62fe; color: white;' : ''}
    `;
    
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}